name: Next.js CI/CD to cPanel (Automated Build & SFTP Deploy, Manual Restart)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Build Next.js project
      run: npm run build

    - name: Deploy .next/standalone via SFTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server_directory: /home/ohkebsmg/public_html/portal/.next/
        local_dir: ./.next/standalone/

    - name: Deploy public/ via SFTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server_directory: /home/ohkebsmg/public_html/portal/
        local_dir: ./public/

    - name: Deploy package.json via SFTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server_directory: /home/ohkebsmg/public_html/portal/
        local_dir: ./package.json

    - name: Deploy node_modules/ via SFTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server_directory: /home/ohkebsmg/public_html/portal/
        local_dir: ./node_modules/

    - name: Manual Deployment Instructions
      run: |
        echo "----------------------------------------------------------------------"
        echo "--- Next.js CI/CD: BUILD and SFTP DEPLOYMENT COMPLETED SUCCESSFULLY! ---"
        echo "----------------------------------------------------------------------"
        echo "ВАШІ ФАЙЛИ ЗАВАНТАЖЕНО НА СЕРВЕР. АЛЕ ДЛЯ ПОВНОГО ЗАПУСКУ ПОТРІБНІ РУЧНІ КРОКИ:"
        echo ""
        echo "1. ОЧИЩЕННЯ СТАРИХ ФАЙЛІВ (РЕКОМЕНДОВАНО):"
        echo "   Зайдіть у cPanel -> 'Файловый менеджер' -> /home/ohkebsmg/public_html/portal/"
        echo "   Видаліть папки '.next', 'public' та 'node_modules' (якщо вони були там раніше)."
        echo "   (Якщо ви покладаєтесь на SFTP перезапис, цей крок не обов'язковий, але кращий для чистоти)."
        echo ""
        echo "2. ПЕРЕЗАПУСК NODE.JS ДОДАТКА:"
        echo "   Зайдіть у cPanel -> 'Настройка Node.js приложений'."
        echo "   Знайдіть додаток 'workts.com.ua/portal'."
        echo "   Натисніть кнопку 'Перезапустить'."
        echo ""
        echo "--- СТАДІЯ: ОЧІКУВАННЯ НА РУЧНИЙ ПЕРЕЗАПУСК ---"
        echo "Ваш сайт має бути оновлено за декілька хвилин після виконання ручних кроків."
        echo "----------------------------------------------------------------------"
        exit 0